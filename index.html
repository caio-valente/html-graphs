<!DOCTYPE html>
<html>
  <head>
    <title>Parcel Sandbox</title>
    <meta charset="UTF-8" />
    <!-- Include Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <!-- Include Merriweather Sans Font -->
    <link rel="preconnect" href="https://fonts.gstatic.com" />
    <link
      href="https://fonts.googleapis.com/css2?family=Merriweather+Sans&display=swap"
      rel="stylesheet"
    />
  </head>

  <body>
    <!-- Style for empty spacer (for testing) -->
    <style>
      .spacer {
        min-height: 125vh;
      }
    </style>

    <!-- Spacer for testing -->
    <div class="spacer">
      Scroll below to activate graph. Or go <a href="index.html">back</a>
    </div>

    <!-- Place this code on the position for the graph 1 -->
    <div id="reach1"></div>
    <div style="min-height: 500px; max-width: 800px;" id="container1"></div>

    <!-- Spacer for testing -->
    <div class="spacer">
      Scroll below to activate graph. Or go <a href="index.html">back</a>
    </div>

    <!-- Place this code on the position for the graph 2 -->
    <div id="reach2"></div>
    <div style="min-height: 500px; max-width: 800px;" id="container2"></div>

    <!-- Spacer for testing -->
    <div class="spacer">
      Scroll below to activate graph. Or go <a href="index.html">back</a>
    </div>

    <!-- Place this code on the position for the graph 3 -->
    <div id="reach3"></div>
    <div style="min-height: 500px; max-width: 800px;" id="container3"></div>

    <!-- Spacer for testing -->
    <div class="spacer">
      Scroll below to activate graph. Or go <a href="index.html">back</a>
    </div>

    <!-- Place this code on the position for the graph 4 -->
    <div id="reach4"></div>
    <div style="min-height: 500px; max-width: 800px;" id="container4"></div>

    <!-- Spacer for testing -->
    <div class="spacer">
      Scroll below to activate graph. Or go <a href="index.html">back</a>
    </div>

    <!-- Place this code on the position for the graph 5 -->
    <div id="reach5"></div>
    <div style="min-height: 500px; max-width: 800px;" id="container5"></div>

    <!-- Spacer for testing -->
    <div class="spacer">
      Scroll below to activate graph. Or go <a href="index.html">back</a>
    </div>

    <!-- Place this code on the position for the graph 6 -->
    <div id="reach6"></div>
    <div style="min-height: 500px; max-width: 800px;" id="container6"></div>

    <!-- Beginning of JavaScript -->
    <script>
      // Defines the location of the datasets.
      // You can host those files on your website and change the location here
      var myurl1 = "https://caio-valente.github.io/html-graphs/ccisw.json";
      var myurl2 = "https://caio-valente.github.io/html-graphs/cpswd.json";
      var myurl3 = "https://caio-valente.github.io/html-graphs/cpwg.json";
      var myurl4 = "https://caio-valente.github.io/html-graphs/fadw.json";
      var myurl5 = "https://caio-valente.github.io/html-graphs/ppw.json";
      var myurl6 = "https://caio-valente.github.io/html-graphs/tbiw2.json";

      // IntersectionObserver to trigger the beginning of the animation
      var observer = new IntersectionObserver(
        function (entries) {
          // isIntersecting is true when element and viewport are overlapping
          // isIntersecting is false when element and viewport don't overlap
          if (entries[0].isIntersecting) {
            // Calls the function to get the data and plot the graph
            // Passes the target id of the reached div
            fetch_json_and_plot(entries[0].target.id);
            observer.unobserve(entries[0].target);
          }
        },
        { threshold: [0] }
      );
      // Puts an observer on each div to be reached
      observer.observe(document.querySelector("#reach1"));
      observer.observe(document.querySelector("#reach2"));
      observer.observe(document.querySelector("#reach3"));
      observer.observe(document.querySelector("#reach4"));
      observer.observe(document.querySelector("#reach5"));
      observer.observe(document.querySelector("#reach6"));

      function fetch_json_and_plot(reached) {
        // gets the json with Plotly.d3.json and
        // calls make_graph with the correct target
        if (reached == "reach1") {
          Plotly.d3.json(myurl1, (err, raw) =>
            make_graph(err, raw, "container1")
          );
        } else if (reached == "reach2") {
          Plotly.d3.json(myurl2, (err, raw) =>
            make_graph(err, raw, "container2")
          );
        } else if (reached == "reach3") {
          Plotly.d3.json(myurl3, (err, raw) =>
            make_graph(err, raw, "container3")
          );
        } else if (reached == "reach4") {
          Plotly.d3.json(myurl4, (err, raw) =>
            make_graph(err, raw, "container4")
          );
        } else if (reached == "reach5") {
          Plotly.d3.json(myurl5, (err, raw) =>
            make_graph(err, raw, "container5")
          );
        } else if (reached == "reach6") {
          Plotly.d3.json(myurl6, (err, raw) =>
            make_graph(err, raw, "container6")
          );
        } else {
          return;
        }
      }

      function make_graph(err, raw, target) {
        // takes data and target and generates the graph
        let layout = {}; // Plotly figure layout
        let title = ""; // Removed graph title
        let frames = []; // Animation frames
        let n = raw.x.length; // Number of frames
        let percent = ""; // Add percent symbol on hover
        let traces = []; // Lines
        let annotations = []; // Line titles
        let primary_range = []; // Primary Y Axis Range
        let primary_yaxis_tickformat; // Primary Y Axis Number formating
        let symbol = ""; // Y Axis symbol for currencies
        let fill = null; // Fill below the line
        let dtick = ""; // Overrides automatic distance between X Axis ticks

        if (err !== null) {
          // If Plotly.d3.json gets an error
          console.log("Failed to fetch data");
          return;
        }

        // Generates frames for animation
        // Each frame has 1 more data point than the previous
        for (var i = 0; i < n; i++) {
          let d = [];
          raw.y.forEach(() => {
            d.push({ x: [], y: [] });
          });
          frames[i] = {
            data: d
          };
          raw.y.forEach((element, index) => {
            frames[i].data[index].x = raw.x.slice(0, i + 1);
            frames[i].data[index].y = element.slice(0, i + 1);
          });
        }

        // Specific config for each graph
        if (target == "container1") {
          layout = { ...layout, showlegend: false };
        }
        if (target == "container3") {
          symbol = "$";
          fill = "tozeroy";
        }
        if (target == "container4") {
          dtick = 5;
        }
        if (target == "container5") {
          layout = { ...layout, showlegend: false };
        }
        if (target == "container6") {
          percent = "%";
          dtick = 5;
          layout = { ...layout, showlegend: false };
        }

        // If the graph is multiaxis, configure secondary Y Axis
        if (raw.has_multiaxis) {
          sec_yaxis = "y2";
          primary_yaxis_color = "rgb(124,181,236)";
          layout = {
            ...layout,
            yaxis2: {
              range: [0.8 * raw.min_y[1], 1.2 * raw.max_y[1]],
              overlaying: "y",
              side: "right",
              showgrid: true,
              showline: false,
              showticklabels: true,
              tickformat: ",.2" + raw.yaxis_tickformat,
              zeroline: false,
              ticksuffix: percent,
              tickfont: {
                color: "rgb(73,73,73)",
                family: "Merriweather Sans",
                size: 15
              }
            }
          };
        } else {
          // else keep all lines in axis "y"
          sec_yaxis = "y";
          primary_yaxis_color = "rgb(30,30,30)";
        }

        // Config for graphs with 1 line
        if (raw.y.length == 1) {
          primary_yaxis_tickformat = symbol + ",.0" + raw.yaxis_tickformat;
          primary_range = [0.8 * raw.min_y[0], 1.2 * raw.max_y[0]];
          traces.push({
            x: frames[1].data[0].x,
            y: frames[1].data[0].y,
            fill: fill,
            name: raw.annotation1,
            type: "scatter",
            mode: "markers+lines",
            marker: { size: 3 },
            line: { color: "rgb(124,181,236)", width: 2.6 },
            connectgaps: true,
            hovertemplate:
              "<b>%{x}</b>" +
              "<br>" +
              raw.annotation1 +
              ": <b>%{y:$.2" +
              raw.yaxis_tickformat +
              "}</b><extra></extra>",
            hoverlabel: {
              bgcolor: "rgb(240,240,240)",
              bordercolor: "rgb(124,181,236)",
              font: {
                color: "black",
                family: "Merriweather Sans"
              }
            }
          });
          annotations.push({
            showarrow: false,
            text: "<b>" + raw.annotation1 + "</b>",
            font: {
              family: "Merriweather Sans",
              size: 16,
              color: "rgb(124,181,236)"
            },
            xref: "x",
            yref: "y",
            x: frames[n - 1].data[0].x[n - 1],
            y: frames[n - 1].data[0].y[n - 1],
            yshift: 30
          });
        } else if (raw.y.length == 2) {
          // Config for graphs with 2 lines
          if (raw.has_multiaxis) {
            // 2-line multiaxis
            primary_range = [0.8 * raw.min_y[0], 1.2 * raw.max_y[0]];
          } else {
            // 2-line single axis
            primary_range = [
              0.8 * Math.min(...raw.min_y),
              1.2 * Math.max(...raw.max_y)
            ];
          }
          primary_yaxis_tickformat = ",.0" + raw.yaxis_tickformat;
          traces.push({
            // First line
            x: frames[1].data[0].x,
            y: frames[1].data[0].y,
            name: raw.annotation1,
            type: "scatter",
            mode: "markers+lines",
            marker: { size: 3 },
            line: { color: "rgb(124,181,236)", width: 2.6 },
            connectgaps: true,
            hovertemplate:
              "<b>%{x}</b>" +
              "<br>" +
              raw.annotation1 +
              ": <b>%{y:,.2" +
              raw.yaxis_tickformat +
              "}</b><extra></extra>",
            hoverlabel: {
              bgcolor: "rgb(240,240,240)",
              bordercolor: "rgb(124,181,236)",
              font: {
                color: "black",
                family: "Merriweather Sans"
              }
            }
          });
          traces.push({
            // Second line
            x: frames[1].data[1].x,
            y: frames[1].data[1].y,
            yaxis: sec_yaxis,
            name: raw.annotation2,
            type: "scatter",
            mode: "markers+lines",
            marker: { size: 3 },
            line: { color: "rgb(73,73,73)", width: 2.6 },
            connectgaps: true,
            hovertemplate:
              "<b>%{x}</b>" +
              "<br>" +
              raw.annotation2 +
              ": <b>%{y:,.2" +
              raw.yaxis_tickformat +
              "}" +
              percent +
              "</b><extra></extra>",
            hoverlabel: {
              bgcolor: "rgb(240,240,240)",
              bordercolor: "rgb(73,73,73)",
              font: {
                color: "black",
                family: "Merriweather Sans"
              }
            }
          });
          if (
            target == "container1" ||
            target == "container5" ||
            target == "container6"
          ) {
            // Annotations for graphs 1, 5 and 6
            console.log(raw);
            let x = [];
            let y = [];
            let shift = [];
            if (target == "container1") {
              x.push(frames[n - 1].data[0].x[12], frames[n - 1].data[1].x[12]);
              y.push(frames[n - 1].data[0].y[12], frames[n - 1].data[1].y[12]);
              shift.push(60, 30);
            }
            if (target == "container5") {
              x.push(frames[n - 1].data[0].x[48], frames[n - 1].data[1].x[35]);
              y.push(frames[n - 1].data[0].y[48], frames[n - 1].data[1].y[48]);
              shift.push(-30, 45);
            }
            if (target == "container6") {
              x.push(frames[n - 1].data[0].x[29], frames[n - 1].data[1].x[25]);
              y.push(frames[n - 1].data[0].y[29], frames[n - 1].data[1].y[25]);
              shift.push(90, -90);
            }
            annotations.push({
              showarrow: false,
              text: "<b>" + raw.annotation1 + "</b>",
              font: {
                family: "Merriweather Sans",
                size: 16,
                color: "rgb(124,181,236)"
              },
              xref: "x",
              yref: "y",
              x: x[0],
              y: y[0],
              yshift: shift[0]
            });
            annotations.push({
              showarrow: false,
              text: "<b>" + raw.annotation2 + "</b>",
              font: {
                family: "Merriweather Sans",
                size: 16,
                color: "rgb(73,73,73)"
              },
              xref: "x",
              yref: sec_yaxis,
              x: x[1],
              y: y[1],
              yshift: shift[1]
            });
          } else if (target == "container2") {
            // No annotations for graph 2
            annotations = [];
          }
        }
        Plotly.plot(
          // Plotly function to generate graph
          target, // Div id to plot to
          traces, // Lines
          {
            // Layout object
            ...layout,
            title: {
              text: title,
              font: {
                family: "Merriweather Sans",
                size: 24,
                color: "black"
              }
            },
            xaxis: {
              range: [raw.min_x - 1, raw.max_x + 1],
              showgrid: false,
              showline: false,
              showticklabels: true,
              zeroline: false,
              dtick: dtick,
              tickfont: {
                family: "Merriweather Sans",
                size: 15
              }
            },
            yaxis: {
              range: primary_range,
              showgrid: true,
              showline: false,
              showticklabels: true,
              tickformat: primary_yaxis_tickformat,
              zeroline: false,
              tickfont: {
                color: primary_yaxis_color,
                family: "Merriweather Sans",
                size: 15
              }
            },
            hovermode: "closest",
            legend: {
              xref: "paper",
              yref: "paper",
              x: 0.15,
              y: 0.5,
              font: {
                family: "Merriweather Sans",
                size: 12
              }
            },
            annotations: annotations
          },
          { responsive: true } // Resize with parent
        ).then(function () {
          // Animation
          Plotly.animate(target, frames, {
            transition: {
              duration: 0
            },
            frame: {
              duration: 30, // Change this to change animation speed
              redraw: false
            }
          });
        });
      }
    </script>
  </body>
</html>
