<!DOCTYPE html>
<html>
  <head>
    <title>Parcel Sandbox</title>
    <meta charset="UTF-8" />
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link rel="preconnect" href="https://fonts.gstatic.com" />
    <link
      href="https://fonts.googleapis.com/css2?family=Merriweather+Sans&display=swap"
      rel="stylesheet"
    />
  </head>

  <body>
    <style>
      .spacer {
        min-height: 125vh;
      }
    </style>
    <div class="spacer">Scroll below to activate graph</div>
    <div id="reach1"></div>
    <div style="min-height: 500px;" id="container1"></div>
    <div class="spacer">Scroll below to activate graph</div>
    <div id="reach2"></div>
    <div style="min-height: 500px;" id="container2"></div>
    <div class="spacer">Scroll below to activate graph</div>
    <div id="reach3"></div>
    <div style="min-height: 500px;" id="container3"></div>
    <div class="spacer">Scroll below to activate graph</div>
    <div id="reach4"></div>
    <div style="min-height: 500px;" id="container4"></div>
    <div class="spacer">Scroll below to activate graph</div>
    <div id="reach5"></div>
    <div style="min-height: 500px;" id="container5"></div>
    <div class="spacer">Scroll below to activate graph</div>
    <div id="reach6"></div>
    <div style="min-height: 500px;" id="container6"></div>

    <script>
      var myurl1 = "https://caio-valente.github.io/html-graphs/ccisw.json";
      var myurl2 = "https://caio-valente.github.io/html-graphs/cpswd.json";
      var myurl3 = "https://caio-valente.github.io/html-graphs/cpwg.json";
      var myurl4 = "https://caio-valente.github.io/html-graphs/fadw.json";
      var myurl5 = "https://caio-valente.github.io/html-graphs/ppw.json";
      var myurl6 = "https://caio-valente.github.io/html-graphs/tbiw.json";

      var d3 = Plotly.d3;
      // const range = (start, end, length = end - start + 1) =>
      //   Array.from({ length }, (_, i) => start + i);
      var observer = new IntersectionObserver(
        function (entries) {
          // isIntersecting is true when element and viewport are overlapping
          // isIntersecting is false when element and viewport don't overlap
          if (entries[0].isIntersecting === true) {
            fetch_json(entries[0].target.id);
            observer.unobserve(entries[0].target);
          }
        },
        { threshold: [0] }
      );
      observer.observe(document.querySelector("#reach1"));
      observer.observe(document.querySelector("#reach2"));
      observer.observe(document.querySelector("#reach3"));
      observer.observe(document.querySelector("#reach4"));
      observer.observe(document.querySelector("#reach5"));
      observer.observe(document.querySelector("#reach6"));
      function fetch_json(reached) {
        if (reached == "reach1") {
          Plotly.d3.json(myurl1, (err, raw) =>
            make_graph(err, raw, "container1")
          );
        } else if (reached == "reach2") {
          Plotly.d3.json(myurl2, (err, raw) =>
            make_graph(err, raw, "container2")
          );
        } else if (reached == "reach3") {
          Plotly.d3.json(myurl3, (err, raw) =>
            make_graph(err, raw, "container3")
          );
        } else if (reached == "reach4") {
          Plotly.d3.json(myurl4, (err, raw) =>
            make_graph(err, raw, "container4")
          );
        } else if (reached == "reach5") {
          Plotly.d3.json(myurl5, (err, raw) =>
            make_graph(err, raw, "container5")
          );
        } else if (reached == "reach6") {
          Plotly.d3.json(myurl6, (err, raw) =>
            make_graph(err, raw, "container6")
          );
        }
      }
      function make_graph(err, raw, target) {
        console.log(target);
        if (err !== null) {
          console.log("Failed to fetch data");
          return;
        }
        if (raw.has_multiaxis) {
          sec_yaxis = "y2";
          primary_yaxis_color = "rgb(124,181,236)";
          var layout = {
            yaxis2: {
              range: [0.8 * raw.min_y[1], 1.2 * raw.max_y[1]],
              overlaying: "y",
              side: "right",
              showgrid: true,
              showline: false,
              showticklabels: true,
              tickformat: ",.2" + raw.yaxis_tickformat,
              zeroline: false,
              tickfont: {
                color: "rgb(73,73,73)",
                family: "Merriweather Sans",
                size: 12
              }
            }
          };
        } else {
          sec_yaxis = "y";
          primary_yaxis_color = "rgb(30,30,30)";
          var layout = {};
        }
        console.log(raw, err);
        let data_x = raw.x;
        let title = raw.title;
        var frames = [];
        var n = data_x.length;
        for (var i = 0; i < n; i++) {
          let d = [];
          raw.y.forEach(() => {
            d.push({ x: [], y: [] });
          });
          frames[i] = {
            data: d
          };
          raw.y.forEach((element, index) => {
            frames[i].data[index].x = data_x.slice(0, i + 1);
            frames[i].data[index].y = element.slice(0, i + 1);
          });
        }
        let traces = [];
        let annotations = [];
        let primary_range = [];
        let primary_yaxis_tickformat;
        if (raw.y.length == 1) {
          primary_yaxis_tickformat = ",.2" + raw.yaxis_tickformat;
          primary_range = [0.8 * raw.min_y[0], 1.2 * raw.max_y[0]];
          traces.push({
            x: frames[1].data[0].x,
            y: frames[1].data[0].y,
            name: raw.annotation1,
            type: "scatter",
            mode: "markers+lines",
            marker: { size: 3 },
            line: { color: "rgb(124,181,236)", width: 2.6 },
            connectgaps: true,
            hovertemplate:
              "<b>%{x}</b>" +
              "<br>" +
              raw.annotation1 +
              ": <b>%{y:.2" +
              raw.yaxis_tickformat +
              "}</b><extra></extra>",
            hoverlabel: {
              bgcolor: "rgb(240,240,240)",
              bordercolor: "rgb(124,181,236)",
              font: {
                color: "black",
                family: "Merriweather Sans"
              }
            }
          });
          annotations.push({
            showarrow: false,
            text: "<b>" + raw.annotation1 + "</b>",
            font: {
              family: "Merriweather Sans",
              size: 16,
              color: "rgb(124,181,236)"
            },
            xref: "x",
            yref: "y",
            x: frames[n - 1].data[0].x[n - 1],
            y: frames[n - 1].data[0].y[n - 1],
            yshift: 30
          });
        } else if (raw.y.length == 2) {
          if (raw.has_multiaxis) {
            primary_range = [0.8 * raw.min_y[0], 1.2 * raw.max_y[0]];
          } else {
            primary_range = [
              0.8 * Math.min(raw.min_y),
              1.2 * Math.max(raw.max_y)
            ];
          }
          primary_yaxis_tickformat = ",.2" + raw.yaxis_tickformat;
          traces.push({
            x: frames[1].data[0].x,
            y: frames[1].data[0].y,
            name: raw.annotation1,
            type: "scatter",
            mode: "markers+lines",
            marker: { size: 3 },
            line: { color: "rgb(124,181,236)", width: 2.6 },
            connectgaps: true,
            hovertemplate:
              "<b>%{x}</b>" +
              "<br>" +
              raw.annotation1 +
              ": <b>%{y:,.2" +
              raw.yaxis_tickformat +
              "}</b><extra></extra>",
            hoverlabel: {
              bgcolor: "rgb(240,240,240)",
              bordercolor: "rgb(124,181,236)",
              font: {
                color: "black",
                family: "Merriweather Sans"
              }
            }
          });
          traces.push({
            x: frames[1].data[1].x,
            y: frames[1].data[1].y,
            yaxis: sec_yaxis,
            name: raw.annotation2,
            type: "scatter",
            mode: "markers+lines",
            marker: { size: 3 },
            line: { color: "rgb(73,73,73)", width: 2.6 },
            hovertemplate:
              "<b>%{x}</b>" +
              "<br>" +
              raw.annotation2 +
              ": <b>%{y:,.2" +
              raw.yaxis_tickformat +
              "}</b><extra></extra>",
            hoverlabel: {
              bgcolor: "rgb(240,240,240)",
              bordercolor: "rgb(73,73,73)",
              font: {
                color: "black",
                family: "Merriweather Sans"
              }
            }
          });
          annotations = [
            {
              showarrow: false,
              text: "<b>" + raw.annotation1 + "</b>",
              font: {
                family: "Merriweather Sans",
                size: 16,
                color: "rgb(124,181,236)"
              },
              xref: "x",
              yref: "y",
              x: frames[n - 1].data[0].x[n - 1],
              y: frames[n - 1].data[0].y[n - 1],
              yshift: 30
            },
            {
              showarrow: false,
              text: "<b>" + raw.annotation2 + "</b>",
              font: {
                family: "Merriweather Sans",
                size: 16,
                color: "rgb(73,73,73)"
              },
              xref: "x",
              yref: sec_yaxis,
              x: frames[n - 1].data[1].x[n - 1],
              y: frames[n - 2].data[1].y[n - 2],
              yshift: 30
            }
          ];
        } else {
          if (raw.has_multiaxis) {
            primary_range = [0.8 * raw.min_y[0], 1.2 * raw.max_y[0]];
          } else {
            primary_range = [
              0.8 * Math.min(raw.min_y),
              1.2 * Math.max(raw.max_y)
            ];
          }
          primary_yaxis_tickformat = "";
          traces.push({
            x: frames[1].data[1].x,
            y: frames[1].data[1].y,
            name: raw.annotation3,
            type: "scatter",
            mode: "markers+lines",
            marker: { size: 3 },
            line: { color: "rgb(73,73,73)", width: 2.6 },
            hovertemplate:
              "<b>%{x}</b>" +
              "<br>" +
              raw.annotation3 +
              ": <b>%{y:$,.2" +
              raw.yaxis_tickformat +
              "}</b><extra></extra>",
            hoverlabel: {
              bgcolor: "rgb(240,240,240)",
              bordercolor: "rgb(73,73,73)",
              font: {
                color: "black",
                family: "Merriweather Sans"
              }
            }
          });
          traces.push({
            x: frames[1].data[0].x,
            y: frames[1].data[0].y,
            name: raw.annotation1,
            type: "scatter",
            mode: "markers+lines",
            marker: { size: 3 },
            line: { color: "rgb(124,181,236)", width: 2.6 },
            connectgaps: true,
            hovertemplate:
              "<b>%{x}</b>" +
              "<br>" +
              raw.annotation1 +
              ": <b>%{y:$,.2" +
              raw.yaxis_tickformat +
              "}</b><extra></extra>",
            hoverlabel: {
              bgcolor: "rgb(240,240,240)",
              bordercolor: "rgb(124,181,236)",
              font: {
                color: "black",
                family: "Merriweather Sans"
              }
            }
          });
          traces.push({
            x: frames[1].data[2].x,
            y: frames[1].data[2].y,
            yaxis: sec_yaxis,
            name: raw.annotation2,
            type: "scatter",
            mode: "markers+lines",
            marker: { size: 3 },
            line: { color: "rgb(150,150,150)", width: 2.6 },
            connectgaps: true,
            hovertemplate:
              "<b>%{x}</b>" +
              "<br>" +
              raw.annotation2 +
              ": <b>%{y:,.2" +
              raw.yaxis_tickformat +
              "}</b><extra></extra>",
            hoverlabel: {
              bgcolor: "rgb(240,240,240)",
              bordercolor: "rgb(124,181,236)",
              font: {
                color: "black",
                family: "Merriweather Sans"
              }
            }
          });
        }
        Plotly.plot(
          target,
          traces,
          {
            ...layout,
            title: {
              text: title,
              font: {
                family: "Merriweather Sans",
                size: 24,
                color: "black"
              }
            },
            xaxis: {
              range: [raw.min_x - 1, raw.max_x + 5],
              showgrid: false,
              showline: false,
              showticklabels: true,
              zeroline: false,
              tickfont: {
                family: "Merriweather Sans",
                size: 12
              }
            },
            yaxis: {
              range: primary_range,
              showgrid: true,
              showline: false,
              showticklabels: true,
              tickformat: primary_yaxis_tickformat,
              zeroline: false,
              tickfont: {
                color: primary_yaxis_color,
                family: "Merriweather Sans",
                size: 12
              }
            },
            hovermode: "closest",
            legend: {
              xref: "paper",
              yref: "paper",
              x: 0.15,
              y: 0.8,
              font: {
                family: "Merriweather Sans",
                size: 12
              }
            },
            annotations: annotations
          },
          { responsive: true }
        ).then(function () {
          Plotly.animate(target, frames, {
            transition: {
              duration: 0
            },
            frame: {
              duration: 10,
              redraw: false
            }
          });
        });
      }
    </script>
  </body>
</html>
